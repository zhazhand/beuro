!function(){function e(e,t){e.when("/",{templateUrl:"home/home.view.html"}).when("/admin",{templateUrl:"views/admin.view.html"}).when("/manager",{templateUrl:"views/manager.view.html"}).when("/table",{templateUrl:"views/table.view.html"}).when("/ban",{templateUrl:"views/ban.view.html"}).when("/list",{templateUrl:"views/list.view.html"}).when("/touristes",{templateUrl:"views/fullList.view.html"}).otherwise({redirectTo:"/"}),t.html5Mode({enabled:!0,requireBase:!1})}angular.module("bpApp",["ngRoute"]),e.$inject=["$routeProvider","$locationProvider"],angular.module("bpApp").config(["$routeProvider","$locationProvider",e])}(),function(){function e(e,t,n,a,r,i){e.pass={},e.current={year:(new Date).getFullYear(),member:""},e.test=function(){if(e.login.name)for(var t=0;t<e.items.length;t++){var n=e.login.name;if(n=new RegExp("^"+n+"$","i"),-1!=e.items[t].login.search(n)){e.login.state=!0;break}e.login.state=!1}},e.testPass=function(n,a){if(a){var r={};r.login=n,r.password=a,t.post("/api/logins",r).then(function(t){t.data?(e.pass.state=!0,e.current.member=t.data):e.pass.state=!1})}else e.pass.state=!1,e.current.member=null},t.get("/api/logins").then(function(n){n.data.length?e.items=n.data:i.dataManager("Администратор","admin","123456",!0).then(function(){t.get("/api/logins").then(function(t){e.items=t.data})})},function(e,t,a,r){n.log(e),n.log(t),n.log(a),n.log(r)}),e.toOpenData=function(){r.setCurrent(e.current);var t=e.current.member;"admin"==t.login?a.path("/admin"):(t.admission?a.path("/manager"):a.path("/ban"),e.login.name="",e.login.pass="")}}angular.module("bpApp").controller("homeCtrl",e),e.$inject=["$scope","$http","$log","$location","bpCurrent","addManager"]}(),function(){function e(e,t,n,a,r){function i(){for(var t=e.client.country,n=0;n<e.countries.length;n++){var a=e.countries[n].name;if(t.toLowerCase()==a.toLowerCase()){e.page.region=e.countries[n].region;break}}}if(r.getCurrent()){var o=r.getCurrent(),l="year="+o.year+"&_id="+o.member._id+"&name="+o.member.name;n.search(l)}e.current=n.search(),t.get("api/country").then(function(t){e.countries=t.data},function(e,t,n,r){a.log(e),a.log(t),a.log(n),a.log(r)}),e.page={comf:0,newClient:0,earlyCountries:[],airports:[],terminals:["Киев","Днепр","Запорожье","Кривой Рог","Харьков","Одесса","Львов"],setChildrenArray:[],childrenListFlag:!1,step1:!1,step2:!1,step3:!1,step4:!1,step5:!1,step6:!1,step7:!1,step15:!1},e.client={},e.page.toInp=function(){i()},e.page.toSelect=function(){e.client.country="",e.page.selected==e.countries[e.countries.length-1]?e.page.step7=!0:(e.page.step7=!1,e.client.country=e.page.selected.name),i(),e.client.manager=e.current.name,e.client.index_id=e.current._id;var t=e.client.manager;t=t.split(" "),e.current.firstName=t[0]},e.page.newStep=function(){e.page.newClient=e.page.newClient+1},e.page.oldStep=function(){e.page.newClient=e.page.newClient-1},e.page.comfort=function(t){e.page.comf=t,1==e.page.comf&&(e.client.startTalk=new Date)},e.page.peopleAmount=function(){for(var e=[],t=0;t<15;t++)e[t]=+t+1;return e.push(">15"),e}(),e.page.noChildren=function(t){e.page.step3=t},e.page.childrenAmount=function(){for(var e=[],t=0;t<15;t++)e[t]=+t+1;return e}(),e.client.setChildrenQuantity=function(t){e.page.setChildrenArray.length=0;for(var n=0;n<t;n++)e.page.setChildrenArray[n]=+n+1},e.client.childrenList=[],e.client.countChildren=function(t,n,a){var r=0,i="";i=1==n?" год":n>1&&n<5?" года":" лет",e.client.childrenList[t]=+t+1+" ребенок - возраст "+n+i;for(var o=0;o<a;o++)e.client.childrenList[o]&&r++;e.page.childrenListFlag=r==a},e.page.toSelectCountries=function(){e.page.earlyCountries.length=0;for(var t=0;t<e.client.selectCountries.length;t++)e.page.earlyCountries.push(e.client.selectCountries[t].name);e.client.countryVisitedEarly=e.page.earlyCountries.join(", ")},e.page.changeCountryVisited=function(t){return e.page.step2=t},e.page.changeAirport=function(t){e.page.step4=t},e.page.toSelectAirport=function(){e.page.airports.length=0;for(var t=0;t<e.page.selectAirport.length;t++)e.page.airports.push(e.page.selectAirport[t]);e.client.favoriteAirports=e.page.airports.join(", ")},e.client.countryRegions=[],e.page.toSelectRegion=function(){e.client.countryRegions.length=0;for(var t=0;t<e.client.selectRegion.length;t++)e.client.countryRegions.push(e.client.selectRegion[t]);e.client.favoriteRegion=e.client.countryRegions.join(", ")},e.client.changeRegion=function(t){e.page.step5=t},e.client.hotelStars=[],e.client.hotelTypes=[],e.page.toStar=function(t,n){e.page.step6=!0;var a=t;a=a.split("-"),+a[1]?n.push(a[0]):n.splice(n.indexOf(a[0]),1)},e.client.selectMotiv=function(t,n){var a=(new Date).getHours()+2,r="сегодня, к обеду (в районе"+(+a+1)+"часов)";e.client.time=a>=18?"завтра утром (мы работаем с 10 часов)":a<14?r:"сегодня, после обеда (мы работаем до 18 часов, но можем немного задержаться)",e.client.restMotivation=t||"что-то другое",e.page.step15=n},e.page.goTable=function(){e.client.endTalk=new Date,e.setTalkDuration(),t.post("/api/tourist",e.client).then(function(t){e.current.tourist_id=t.data._id,r.setCurrent(e.current),n.path("/table")},function(e,t,n,r){a.log(e),a.log(t),a.log(n),a.log(r)})},e.page.listOfTourists=function(){n.path("/list")},e.setTalkDuration=function(){return e.client.talkDuration=+(e.client.endTalk-e.client.startTalk)},e.client.endTalkRequirements=function(){return e.client.endRequirements=new Date,e.page.step1=!0,e.client.requirements=+(e.client.endRequirements-e.client.startTalk)}}angular.module("bpApp").controller("managerCtrl",e),e.$inject=["$scope","$http","$location","$log","bpCurrent"]}(),function(){function e(e,t,n,a,r,i,o){function l(t){n.delete("/api/manager?id="+t._id).then(function(t){a.log("success",t.data),e.items.splice(e.items.indexOf(t.data),1)},function(e,t,n,r){a.log(e),a.log(t),a.log(n),a.log(r)})}if(i.getCurrent()){var u=i.getCurrent();r.sessionStorage.setItem("_id",u.member._id);var c="year="+u.year+"&_id="+u.member._id+"&name="+u.member.name;t.search(c)}e.current=t.search(),e.admin=!!e.current._id,e.current._id===r.sessionStorage.getItem("_id")&&function(){n.get("/api/manager").then(function(t){e.items=t.data},function(e,t,n){a.log(e),a.log(t),a.log(n)})}(),e.backToStartPage=function(){t.search(""),t.path("/")},e.editTr=function(e,t){for(var n=0;n<e.length;n++)e[n].edit=!1;t.edit=!0},e.addNewManager=function(){for(var t=0,n=0;n<e.items.length;n++)"new"==e.items[n].login&&t++;t?r.alert("Такой менеджер уже существует!"):o.dataManager("Новый","new","new",!1).then(function(t){e.items.push(t.data)},function(e,t,n,r){a.log(e),a.log(t),a.log(n),a.log(r)})},e.showModal=function(t){e.deletingManager=t,e.managers=[];for(var n=0;n<e.items.length;n++)e.items[n]._id!=e.deletingManager._id&&e.managers.push(e.items[n]),e.managers.length&&(e.newManager=e.managers[0])},e.touristes=[],e.changeManagerAndDelete=function(t){t?n.get("/api/tourist/touristes_list/"+e.deletingManager._id).then(function(t){return e.touristes=t.data,e.touristes.length}).then(function(a){if(a){var r={};r.index_id=t._id,r.manager=t.name,r._id=e.deletingManager._id,n.put("/api/touristes_change",r)}}).then(function(){l(e.deletingManager),angular.element("#adminModal").modal("hide")}):r.alert("Выберите нового менеджера!!!")},e.changeAdminData=function(t,i){var o={};o._id=e.current._id,o.oldPassword=t,o.newPassword=i,n.put("/api/admin",o).then(function(t){a.log(t.status),e.oldPass="",e.newPass="",e.repeatPass="",angular.element("#adminDataModal").modal("hide")}).catch(function(e){a.log(e.status),r.alert("НЕВЕРНЫЙ ИСХОДНЫЙ ПАРОЛЬ!")})},e.showAll=function(){t.path("/touristes")},e.save=function(e){n.put("/api/manager",e).then(function(e){a.log("success",e.data)},function(){a.log("error")})}}angular.module("bpApp").controller("adminCtrl",e),e.$inject=["$scope","$location","$http","$log","$window","bpCurrent","addManager"]}(),function(){function e(e,t,n){if(n.getCurrent()){var a=n.getCurrent(),r="year="+a.year+"&_id="+a.member._id+"&name="+a.member.name;t.search(r)}e.current=t.search(),e.goHome=function(){t.search(""),t.path("/")}}angular.module("bpApp").controller("banCtrl",e),e.$inject=["$scope","$location","bpCurrent"]}(),function(){function e(e,t,n,a,r){if(r.getCurrent()){var i=r.getCurrent(),o="year="+i.year+"&_id="+i._id+"&name="+i.name+"&tourist_id="+i.tourist_id;t.search(o)}e.current=t.search(),n.get("/api/tourist/tourist_id/"+e.current.tourist_id).then(function(t){e.tourist=t.data},function(e,t,n,r){a.log(e),a.log(t),a.log(n),a.log(r)}),e.goHome=function(){e.current.member={},e.current.member.name=e.current.name,e.current.member._id=e.current._id,r.setCurrent(e.current),"Администратор"==e.current.name?t.path("/admin"):t.path("/manager")},e.exportData=function(){var t=angular.element(document.querySelectorAll(".panel-body tbody>tr"));e.exportTable={};for(var n=0;n<t.length;n++){var a=t.eq(n).find("td").eq(0).text(),r=t.eq(n).find("td").eq(1).text();a&&(e.exportTable[a]=r)}alasql('SELECT * INTO XLSX("tourist.xlsx",{headers:true}) FROM ?',[e.exportTable])}}angular.module("bpApp").controller("tableCtrl",e),e.$inject=["$scope","$location","$http","$log","bpCurrent"]}(),function(){function e(e,t,n,a,r){e.current=t.search(),e.page={},e.page.items=[],n.get("/api/tourist/touristes_list/"+e.current._id).then(function(t){e.page.items=t.data,e.len=e.page.items.length},function(e,t,n,r){a.log(e),a.log(t),a.log(n),a.log(r)}),a.log(e.page.items.length),e.page.limitRange=[{name:"Последние 5",value:-5},{name:"Последние 10",value:-10},{name:"Последние 20",value:-20},{name:"Все",value:e.len}],e.page.filterRange=[{name:"Последние вверху",value:"-startTalk"},{name:"Последние внизу",value:"+startTalk"},{name:"По фамилии",value:"lastName"},{name:"По стране",value:"country"}],e.page.limitValue=e.page.limitRange[0],e.page.filterValue=e.page.filterRange[0],e.page.showMore=function(n){e.current.tourist_id=n,r.setCurrent(e.current),t.path("/table")},e.goHome=function(){r.setCurrent(""),t.path("/manager")}}angular.module("bpApp").controller("listCtrl",e),e.$inject=["$scope","$location","$http","$log","bpCurrent"]}(),function(){function e(e,t,n,a,r,i,o){function l(){n.get("/api/tourist").then(function(t){e.page.items=t.data,e.len=e.page.items.length},function(e,t,n,r){a.log(e),a.log(t),a.log(n),a.log(r)})}function u(e,t,n){for(var a=[],r=0;r<e.length;r++)e[r][t]&&e[r][t]!=n&&a.push(e[r]);return a}e.current=t.search(),e.gettingFilter=[],function(){n.get("/api/country").then(function(t){var n=t.data;e.countries=u(n,"name","ДРУГАЯ")},function(e,t,n,r){a.log(e),a.log(t),a.log(n),a.log(r)})}(),function(){n.get("/api/manager").then(function(t){e.managers=t.data,e.gettingFilter=e.managers},function(e,t,n,r){a.log(e),a.log(t),a.log(n),a.log(r)})}(),e.page={},e.page.items=[],l(),e.page.filters=[{name:"По менеджеру",value:"manager"},{name:"По стране",value:"country"},{name:"По месяцу",value:"month"}],e.page.limitRange=[{name:"Последние 5",value:-5},{name:"Последние 10",value:-10},{name:"Последние 20",value:-20},{name:"Все",value:e.len}],e.page.filterRange=[{name:"Последние вверху",value:"-startTalk"},{name:"Последние внизу",value:"+startTalk"},{name:"По фамилии",value:"lastName"},{name:"По стране",value:"country"}],e.page.showRange=[{name:"отображать, потом упорядочивать",value:!0},{name:"фильтровать, потом отображать",value:!1}],e.page.filterChanged=e.gettingFilter[0],e.page.limitValue=e.page.limitRange[0],e.page.filterValue=e.page.filterRange[0],e.page.firstShow=e.page.showRange[0],e.page.additionFilters=e.page.filters[0],e.monthes=function(){for(var e=[],t=["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"],n=0;n<t.length;n++)e[n]={},e[n].name=t[n],e[n].value=n;return e}(),e.changeFilter=function(t){var n;switch(t){case"manager":n=e.managers;break;case"country":n=e.countries;break;case"month":n=e.monthes}e.gettingFilter=n},e.getOldManager=function(t){e.updatingTourist=t},e.saveNewManager=function(t){if(t&&e.updatingTourist.manager!=t.name){var i={};i._id=e.updatingTourist._id,i.index_id=t._id,i.manager=t.name,n.put("/api/tourist",i).then(function(e){a.log("success",e.data),l(),angular.element("#myModal").modal("hide")},function(){a.log("error")})}else r.alert("Нужно выбрать НОВОГО менеджера!")},e.page.showMore=function(n){e.current.tourist_id=n,o.setCurrent(e.current),t.path("/table")},e.goHome=function(){o.setCurrent(""),t.path("/admin")},e.selectItems=function(t){if(!e.page.filterChanged)return!0;switch(e.page.additionFilters.value){case"manager":return t.manager==e.page.filterChanged.name;case"country":return t.country==e.page.filterChanged.name;case"month":return new Date(t.endTalk).getMonth()==e.page.filterChanged.value}}}angular.module("bpApp").controller("fullListCtrl",e),e.$inject=["$scope","$location","$http","$log","$window","$document","bpCurrent"]}(),function(){function e(){var e;return{setCurrent:function(t){e=t},getCurrent:function(){return e}}}angular.module("bpApp").factory("bpCurrent",e)}(),function(){function e(){var e;return{setList:function(t){e=t},getList:function(){return e}}}angular.module("bpApp").factory("bpManagers",e)}(),function(){function e(e){return{dataManager:function(t,n,a,r){var i={name:t,login:n,password:a,admission:r};return e.post("/api/manager",i)}}}angular.module("bpApp").service("addManager",e),e.$inject=["$http"]}(),function(){function e(){return function(e,t){return"boolean"==typeof e?t?e?"Да (есть)":"Нет":e?"Список (см ниже)":"Ни в каких (первый раз)":e}}angular.module("bpApp").filter("yesOrNo",e)}(),function(){function e(){return function(e){if(angular.isNumber(e)){var t=parseInt(e/1e3);return parseInt(t/60)+" минут "+t%60+" секунд"}return e}}angular.module("bpApp").filter("timeFilter",e)}(),function(){function e(){return{templateUrl:"../views/deepIdentification.html"}}angular.module("bpApp").directive("deepIdentification",e)}(),function(){function e(){return{templateUrl:"../views/questioning.html",replace:!0}}angular.module("bpApp").directive("questioningClient",e)}(),function(){function e(){return{templateUrl:"../views/touristWishes.html",replace:!0}}angular.module("bpApp").directive("touristWishes",e)}();